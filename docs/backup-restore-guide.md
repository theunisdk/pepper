# Moltbot Backup & Restore Guide

This guide shows how to backup your moltbot instance configuration and data so you can quickly restore after recreating the EC2 instance.

Throughout this guide, replace `{instance}` with your instance name (e.g., pepper, alfred, jarvis).

## What Needs to be Backed Up

### Critical (Required for Restore)
1. **Moltbot Configuration**: `~/.clawdbot/clawdbot.json`
2. **Environment Variables**: `~/.clawdbot/.env`
3. **OAuth Tokens**: `~/.gog/` (Google Workspace)
4. **Telegram Bot Token**: Already in `clawdbot.json`
5. **Google OAuth Credentials**: `{instance}-credentials.json`

### Optional (Memory/History)
6. **Git Workspace**: `~/moltbot/` (bot's memory, identity, notes)
7. **Chat History**: `~/.clawdbot/sessions/` (conversation logs)

### Not Needed (Recreated by Terraform)
- SSH keys (regenerated by Terraform)
- System configuration (handled by user_data)
- Node.js, moltbot binary (reinstalled)

---

## Backup Methods

### Method 1: Using Moltbot Wrapper (Recommended)

The unified moltbot wrapper handles backups automatically:

```bash
# Backup your instance
./scripts/moltbot {instance} backup

# Backups are saved to: ~/.{instance}-backups/YYYYMMDD-HHMMSS/
# Example: ~/.pepper-backups/20260129-143052/pepper-backup.tar.gz
```

The backup includes:
- `~/.clawdbot/` - Configuration, credentials, sessions
- `~/.gog/` - Google OAuth tokens
- `~/moltbot/` - Workspace, memory, git history

### Method 2: Automatic Daily Backups

Set up a cron job on your local machine:

```bash
# Edit crontab
crontab -e

# Add daily backup at 2 AM for each instance
0 2 * * * cd /home/your-user/dev/private/pepper && ./scripts/moltbot pepper backup
0 2 * * * cd /home/your-user/dev/private/pepper && ./scripts/moltbot alfred backup
```

---

## Restore Process

### Using Moltbot Wrapper

The unified moltbot wrapper handles restores automatically:

```bash
# Restore from a backup file
./scripts/moltbot {instance} restore ~/.{instance}-backups/YYYYMMDD-HHMMSS/{instance}-backup.tar.gz

# Example
./scripts/moltbot pepper restore ~/.pepper-backups/20260129-143052/pepper-backup.tar.gz
```

The restore process:
1. Prompts for confirmation
2. Uploads backup to EC2 instance
3. Stops moltbot service
4. Extracts backup to correct locations
5. Fixes file permissions
6. Restarts moltbot service

---

## Quick Restore After Instance Recreation

### Scenario: EC2 Instance Destroyed/Recreated

1. **Recreate infrastructure**:
   ```bash
   ./scripts/moltbot {instance} terraform apply
   ```

2. **Wait for initialization** (cloud-init completes):
   ```bash
   ./scripts/moltbot {instance} ssh
   cloud-init status --wait
   exit
   ```

3. **Restore backup**:
   ```bash
   # Restore from latest backup
   ./scripts/moltbot {instance} restore ~/.{instance}-backups/<latest>/{instance}-backup.tar.gz
   ```

4. **Verify**:
   ```bash
   ./scripts/moltbot {instance} status
   ```

Done! Your bot is back with all its memory and configuration.

---

## Manual Backup (Without Wrapper)

If you prefer manual commands instead of using the wrapper:

### Backup

```bash
# From your local machine
# Get instance IP: ./scripts/moltbot {instance} terraform output instance_public_ip

ssh -i ~/.ssh/{instance}_key.pem ubuntu@<instance-ip> << 'EOF'
cd /home/clawd
sudo tar -czf /tmp/{instance}-backup.tar.gz \
  .clawdbot/clawdbot.json \
  .clawdbot/.env \
  .clawdbot/sessions/ \
  .gog/ \
  moltbot/
EOF

# Download
scp -i ~/.ssh/{instance}_key.pem ubuntu@<instance-ip>:/tmp/{instance}-backup.tar.gz ~/{instance}-backup-$(date +%Y%m%d).tar.gz
```

### Restore

```bash
# Upload
scp -i ~/.ssh/{instance}_key.pem ~/{instance}-backup-YYYYMMDD.tar.gz ubuntu@<instance-ip>:/tmp/

# Extract
ssh -i ~/.ssh/{instance}_key.pem ubuntu@<instance-ip> << 'EOF'
sudo systemctl stop moltbot
sudo tar -xzf /tmp/{instance}-backup.tar.gz -C /home/clawd/
sudo chown -R clawd:clawd /home/clawd/.clawdbot /home/clawd/.gog /home/clawd/moltbot
sudo systemctl start moltbot
EOF
```

---

## What Gets Restored

| Item | Location | Contents |
|------|----------|----------|
| **Config** | `~/.clawdbot/clawdbot.json` | Telegram bot token, gateway settings, skill config |
| **Env vars** | `~/.clawdbot/.env` | Google account, API keys |
| **OAuth tokens** | `~/.gog/` | Google Workspace access tokens |
| **Memory** | `~/moltbot/` | Bot's identity, memories, git history |
| **Sessions** | `~/.clawdbot/sessions/` | Conversation history |

---

## Backup Storage Recommendations

### Local Backups
```bash
~/.{instance}-backups/
├── 20260128-140000/
│   └── {instance}-backup.tar.gz
├── 20260129-140000/
│   └── {instance}-backup.tar.gz
└── latest -> 20260129-140000/
```

Keep last 7 days locally, delete older.

### Encrypted Cloud Backup (Optional)

```bash
# Encrypt before uploading
gpg --symmetric --cipher-algo AES256 {instance}-backup.tar.gz

# Upload to S3 (requires AWS CLI)
aws s3 cp {instance}-backup.tar.gz.gpg s3://your-bucket/{instance}-backups/

# Restore
aws s3 cp s3://your-bucket/{instance}-backups/{instance}-backup.tar.gz.gpg .
gpg --decrypt {instance}-backup.tar.gz.gpg > {instance}-backup.tar.gz
```

---

## Security Notes

1. **Backup contains secrets**:
   - Telegram bot token
   - Google OAuth tokens
   - API keys
   - Chat history

2. **Protect backups**:
   - Store in encrypted directory
   - Don't commit to git
   - Use strong permissions: `chmod 600 *.tar.gz`

3. **Retention policy**:
   - Keep 7 daily backups
   - Keep 4 weekly backups
   - Delete after 30 days

4. **Before deletion**:
   - Always backup before destroying EC2
   - Test restore on a new instance first

---

## Testing Your Backup

Periodically test the restore process:

```bash
# 1. Create backup
./scripts/moltbot {instance} backup

# 2. Destroy and recreate test instance
./scripts/moltbot {instance} terraform destroy -auto-approve
./scripts/moltbot {instance} terraform apply -auto-approve

# 3. Restore
./scripts/moltbot {instance} restore ~/.{instance}-backups/latest/{instance}-backup.tar.gz

# 4. Verify bot responds on Telegram
```

---

## Disaster Recovery Checklist

- [ ] Latest backup is less than 24 hours old
- [ ] Backup includes `~/.clawdbot/`, `~/.gog/`, `~/moltbot/`
- [ ] `{instance}-credentials.json` saved locally
- [ ] Terraform state is backed up (in `instances/{instance}/.terraform/`)
- [ ] SSH keys are accessible (`~/.ssh/{instance}_key.pem`)
- [ ] You can get instance IP via `./scripts/moltbot {instance} terraform output`
- [ ] Restore tested within last month
- [ ] Google OAuth app still in Google Cloud Console

---

## Quick Reference

```bash
# Backup
./scripts/moltbot {instance} backup

# Restore
./scripts/moltbot {instance} restore ~/.{instance}-backups/<timestamp>/{instance}-backup.tar.gz

# List backups
ls -lh ~/.{instance}-backups/

# Check instance status
./scripts/moltbot {instance} status

# Manual verification via SSH
./scripts/moltbot {instance} ssh
sudo -u clawd ls -la ~/.clawdbot/
exit
```
