# Terraform: Secure EC2 for molt.bot

This Terraform configuration creates a security-hardened EC2 instance in a dedicated VPC for running [molt.bot](https://docs.molt.bot) (formerly clawdbot).

## Security Features

- **Isolated VPC**: Dedicated VPC (10.100.0.0/16) separate from other workloads
- **SSH-only access**: Port 22 restricted to your IP only (NOT 0.0.0.0/0)
- **Gateway NOT exposed**: Port 18789 accessed via SSH tunnel only
- **New SSH key pair**: ED25519 key generated by Terraform
- **OS hardening**: UFW firewall, fail2ban, SSH hardening, non-root user
- **IMDSv2 required**: Protection against SSRF attacks
- **EBS encryption**: Data at rest protection
- **VPC Flow Logs**: Security auditing

## Prerequisites

1. [Terraform](https://www.terraform.io/downloads) >= 1.5.0
2. AWS CLI configured with credentials
3. Your public IP address (run `curl -4 ifconfig.me`)

## Quick Start

### 1. Configure Variables

```bash
cd terraform/environments/prod
cp terraform.tfvars.example terraform.tfvars
```

Edit `terraform.tfvars`:
```hcl
allowed_ssh_cidr = "YOUR_IP/32"  # Replace with your IP
aws_region       = "af-south-1"  # Cape Town
```

### 2. Initialize Terraform

```bash
terraform init
```

### 3. Review the Plan

```bash
terraform plan
```

Verify that:
- Security group SSH ingress shows YOUR IP only
- Port 18789 is NOT in any ingress rules

### 4. Apply

```bash
terraform apply
```

### 5. Note the Outputs

After apply, note these values:
- `instance_public_ip`: Your EC2's public IP
- `ssh_connection_command`: Ready-to-use SSH command
- `ssh_tunnel_command`: Command for gateway access

## Connecting to the Instance

### SSH Access

```bash
ssh -i ~/.ssh/moltbot_key.pem ubuntu@<public-ip>
```

### Gateway Access (via SSH Tunnel)

**NEVER expose port 18789 to the internet.**

1. Create SSH tunnel:
   ```bash
   ssh -i ~/.ssh/moltbot_key.pem -L 18789:127.0.0.1:18789 ubuntu@<public-ip> -N
   ```

2. Access gateway in browser:
   ```
   http://127.0.0.1:18789
   ```

## Post-Deployment: Installing molt.bot

1. SSH to the instance
2. Switch to the clawd user:
   ```bash
   sudo -u clawd -i
   ```
3. Run the onboard wizard:
   ```bash
   moltbot onboard
   ```
4. **Important**: When asked, bind the Gateway to `127.0.0.1` only

## Instance Details

| Property | Value |
|----------|-------|
| OS | Ubuntu 22.04 LTS |
| Instance Type | t3.small |
| Storage | 30 GB gp3 EBS (encrypted) |
| Region | af-south-1 (Cape Town) |
| Node.js | 22+ (auto-installed) |
| User for moltbot | `clawd` |

## Security Hardening Applied

The cloud-init script automatically applies:

- System updates
- Non-root user (`clawd`) with SSH key
- SSH hardening:
  - Root login disabled
  - Password auth disabled
  - Strong ciphers only
  - Limited auth attempts
- UFW firewall (SSH only)
- fail2ban for SSH brute-force protection
- Automatic security updates

## File Structure

```
terraform/
├── environments/prod/
│   ├── main.tf                 # Root module
│   ├── variables.tf            # Environment variables
│   ├── terraform.tfvars        # Your values (gitignored)
│   ├── terraform.tfvars.example
│   └── backend.tf              # State backend config
├── modules/moltbot/
│   ├── main.tf                 # Provider config
│   ├── variables.tf            # Input variables
│   ├── outputs.tf              # Connection info
│   ├── locals.tf               # Local values
│   ├── data.tf                 # AMI lookup
│   ├── vpc.tf                  # VPC, subnet, IGW
│   ├── security.tf             # Security groups, NACLs
│   ├── ec2.tf                  # Instance, key pair
│   ├── iam.tf                  # IAM role
│   └── user_data/init.sh.tftpl # Cloud-init script
└── README.md
```

## Updating Your IP

If your IP changes, update `terraform.tfvars` and run:

```bash
terraform apply
```

## Destroying Resources

To tear down all resources:

```bash
terraform destroy
```

**Warning**: This will delete the EC2 instance and all data.

## Troubleshooting

### Can't SSH to instance

1. Verify your IP matches `allowed_ssh_cidr`:
   ```bash
   curl -4 ifconfig.me
   ```
2. Check security group in AWS Console
3. Ensure key permissions: `chmod 400 ~/.ssh/moltbot_key.pem`

### Cloud-init logs

Check initialization logs:
```bash
sudo cat /var/log/user-data.log
sudo cat /var/log/cloud-init-output.log
```

### Verify security tools

```bash
sudo ufw status
sudo systemctl status fail2ban
node --version
```
