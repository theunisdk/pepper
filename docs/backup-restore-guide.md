# Moltbot Backup & Restore Guide

This guide shows how to backup Pepper's configuration and data so you can quickly restore after recreating the EC2 instance.

## What Needs to be Backed Up

### Critical (Required for Restore)
1. **Moltbot Configuration**: `~/.clawdbot/clawdbot.json`
2. **Environment Variables**: `~/.clawdbot/.env`
3. **OAuth Tokens**: `~/.gog/` (Google Workspace)
4. **Telegram Bot Token**: Already in `clawdbot.json`
5. **Google OAuth Credentials**: `pepper-credentials.json`

### Optional (Memory/History)
6. **Git Workspace**: `~/moltbot/` (Pepper's memory, identity, notes)
7. **Chat History**: `~/.clawdbot/sessions/` (conversation logs)

### Not Needed (Recreated by Terraform)
- SSH keys (regenerated by Terraform)
- System configuration (handled by user_data)
- Node.js, moltbot binary (reinstalled)

---

## Backup Methods

### Method 1: Manual Backup Script (Recommended)

Create a backup script to automate the process:

```bash
# On your local machine
cat > scripts/backup-pepper.sh << 'EOF'
#!/bin/bash
set -euo pipefail

# Configuration
SSH_KEY="${MOLTBOT_SSH_KEY:-$HOME/.ssh/moltbot_key.pem}"
HOST="${MOLTBOT_HOST:-13.247.25.37}"
BACKUP_DIR="${HOME}/.pepper-backups/$(date +%Y%m%d-%H%M%S)"

echo "Creating backup directory: $BACKUP_DIR"
mkdir -p "$BACKUP_DIR"

# Backup from EC2
echo "Backing up from $HOST..."
ssh -i "$SSH_KEY" ubuntu@"$HOST" "sudo tar -czf /tmp/pepper-backup.tar.gz -C /home/clawd .clawdbot .gog moltbot 2>/dev/null || true"

# Download backup
scp -i "$SSH_KEY" ubuntu@"$HOST":/tmp/pepper-backup.tar.gz "$BACKUP_DIR/"

# Cleanup remote
ssh -i "$SSH_KEY" ubuntu@"$HOST" "sudo rm /tmp/pepper-backup.tar.gz"

echo "✓ Backup saved to: $BACKUP_DIR/pepper-backup.tar.gz"
echo ""
echo "Backup contains:"
echo "  - ~/.clawdbot/ (config, credentials, sessions)"
echo "  - ~/.gog/ (Google OAuth tokens)"
echo "  - ~/moltbot/ (workspace, memory, git history)"
echo ""
echo "To restore: ./scripts/restore-pepper.sh $BACKUP_DIR/pepper-backup.tar.gz"
EOF

chmod +x scripts/backup-pepper.sh
```

### Method 2: Automatic Daily Backups

Set up a cron job on your local machine:

```bash
# Edit crontab
crontab -e

# Add daily backup at 2 AM
0 2 * * * /home/theunisdk/dev/private/pepper/scripts/backup-pepper.sh
```

---

## Restore Process

### Automated Restore Script

```bash
# On your local machine
cat > scripts/restore-pepper.sh << 'EOF'
#!/bin/bash
set -euo pipefail

# Configuration
SSH_KEY="${MOLTBOT_SSH_KEY:-$HOME/.ssh/moltbot_key.pem}"
HOST="${MOLTBOT_HOST:-13.247.25.37}"
BACKUP_FILE="$1"

if [[ ! -f "$BACKUP_FILE" ]]; then
    echo "Error: Backup file not found: $BACKUP_FILE"
    echo "Usage: $0 <path-to-backup.tar.gz>"
    exit 1
fi

echo "Restoring from: $BACKUP_FILE"
echo "To host: $HOST"
echo ""
read -p "Continue? (y/n) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
fi

# Upload backup
echo "Uploading backup..."
scp -i "$SSH_KEY" "$BACKUP_FILE" ubuntu@"$HOST":/tmp/pepper-backup.tar.gz

# Extract and restore
echo "Restoring on EC2..."
ssh -i "$SSH_KEY" ubuntu@"$HOST" << 'REMOTE'
sudo systemctl stop moltbot
sudo tar -xzf /tmp/pepper-backup.tar.gz -C /home/clawd/
sudo chown -R clawd:clawd /home/clawd/.clawdbot /home/clawd/.gog /home/clawd/moltbot
sudo rm /tmp/pepper-backup.tar.gz
sudo systemctl start moltbot
REMOTE

echo "✓ Restore complete!"
echo ""
echo "Services restarted:"
echo "  sudo systemctl status moltbot"
EOF

chmod +x scripts/restore-pepper.sh
```

---

## Quick Restore After Instance Recreation

### Scenario: EC2 Instance Destroyed/Recreated

1. **Recreate infrastructure**:
   ```bash
   cd terraform/environments/prod
   AWS_PROFILE=noldor terraform apply
   ```

2. **Wait for initialization** (cloud-init completes):
   ```bash
   ssh -i ~/.ssh/moltbot_key.pem ubuntu@<new-ip> cloud-init status --wait
   ```

3. **Restore backup**:
   ```bash
   # Update host in restore script or set env var
   export MOLTBOT_HOST=<new-ip>

   # Restore from latest backup
   ./scripts/restore-pepper.sh ~/.pepper-backups/<latest>/pepper-backup.tar.gz
   ```

4. **Verify**:
   ```bash
   ssh -i ~/.ssh/moltbot_key.pem ubuntu@<new-ip> "sudo systemctl status moltbot"
   ```

Done! Pepper is back with all her memory and configuration.

---

## Manual Backup (No Scripts)

### Backup

```bash
# From your local machine
ssh -i ~/.ssh/moltbot_key.pem ubuntu@13.247.25.37 << 'EOF'
cd /home/clawd
sudo tar -czf /tmp/pepper-backup.tar.gz \
  .clawdbot/clawdbot.json \
  .clawdbot/.env \
  .clawdbot/sessions/ \
  .gog/ \
  moltbot/
EOF

# Download
scp -i ~/.ssh/moltbot_key.pem ubuntu@13.247.25.37:/tmp/pepper-backup.tar.gz ~/pepper-backup-$(date +%Y%m%d).tar.gz
```

### Restore

```bash
# Upload
scp -i ~/.ssh/moltbot_key.pem ~/pepper-backup-YYYYMMDD.tar.gz ubuntu@<new-ip>:/tmp/

# Extract
ssh -i ~/.ssh/moltbot_key.pem ubuntu@<new-ip> << 'EOF'
sudo systemctl stop moltbot
sudo tar -xzf /tmp/pepper-backup.tar.gz -C /home/clawd/
sudo chown -R clawd:clawd /home/clawd/.clawdbot /home/clawd/.gog /home/clawd/moltbot
sudo systemctl start moltbot
EOF
```

---

## What Gets Restored

| Item | Location | Contents |
|------|----------|----------|
| **Config** | `~/.clawdbot/clawdbot.json` | Telegram bot token, gateway settings, skill config |
| **Env vars** | `~/.clawdbot/.env` | Google account, API keys |
| **OAuth tokens** | `~/.gog/` | Google Workspace access tokens |
| **Memory** | `~/moltbot/` | Pepper's identity, memories, git history |
| **Sessions** | `~/.clawdbot/sessions/` | Conversation history |

---

## Backup Storage Recommendations

### Local Backups
```bash
~/.pepper-backups/
├── 20260128-140000/
│   └── pepper-backup.tar.gz
├── 20260129-140000/
│   └── pepper-backup.tar.gz
└── latest -> 20260129-140000/
```

Keep last 7 days locally, delete older.

### Encrypted Cloud Backup (Optional)

```bash
# Encrypt before uploading
gpg --symmetric --cipher-algo AES256 pepper-backup.tar.gz

# Upload to S3 (requires AWS CLI)
aws s3 cp pepper-backup.tar.gz.gpg s3://your-bucket/pepper-backups/

# Restore
aws s3 cp s3://your-bucket/pepper-backups/pepper-backup.tar.gz.gpg .
gpg --decrypt pepper-backup.tar.gz.gpg > pepper-backup.tar.gz
```

---

## Security Notes

1. **Backup contains secrets**:
   - Telegram bot token
   - Google OAuth tokens
   - API keys
   - Chat history

2. **Protect backups**:
   - Store in encrypted directory
   - Don't commit to git
   - Use strong permissions: `chmod 600 *.tar.gz`

3. **Retention policy**:
   - Keep 7 daily backups
   - Keep 4 weekly backups
   - Delete after 30 days

4. **Before deletion**:
   - Always backup before destroying EC2
   - Test restore on a new instance first

---

## Testing Your Backup

Periodically test the restore process:

```bash
# 1. Create backup
./scripts/backup-pepper.sh

# 2. Destroy and recreate test instance
cd terraform/environments/prod
AWS_PROFILE=noldor terraform destroy -auto-approve
AWS_PROFILE=noldor terraform apply -auto-approve

# 3. Restore
./scripts/restore-pepper.sh ~/.pepper-backups/latest/pepper-backup.tar.gz

# 4. Verify Pepper responds on Telegram
```

---

## Disaster Recovery Checklist

- [ ] Latest backup is less than 24 hours old
- [ ] Backup includes `~/.clawdbot/`, `~/.gog/`, `~/moltbot/`
- [ ] `pepper-credentials.json` saved locally
- [ ] Terraform state is committed/backed up
- [ ] SSH keys are accessible (`~/.ssh/moltbot_key.pem`)
- [ ] You know your EC2 IP or can find it via AWS Console
- [ ] Restore script tested within last month
- [ ] Google OAuth app still in Google Cloud Console

---

## Quick Reference

```bash
# Backup
./scripts/backup-pepper.sh

# Restore
./scripts/restore-pepper.sh ~/.pepper-backups/<timestamp>/pepper-backup.tar.gz

# List backups
ls -lh ~/.pepper-backups/

# Manual verification
ssh -i ~/.ssh/moltbot_key.pem ubuntu@13.247.25.37 "sudo -u clawd ls -la ~/.clawdbot/"
```
