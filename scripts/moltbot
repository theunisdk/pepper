#!/bin/bash
# Moltbot Multi-Instance Manager
# Usage: moltbot <instance> <command> [args...]

set -euo pipefail

# Get script directory and project root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Source libraries
source "$SCRIPT_DIR/lib/common.sh"
source "$SCRIPT_DIR/lib/config.sh"

# Parse arguments
if [[ $# -lt 1 ]]; then
    show_usage
    exit 1
fi

# Special case: help
if [[ "$1" == "help" ]] || [[ "$1" == "--help" ]] || [[ "$1" == "-h" ]]; then
    show_usage
    exit 0
fi

if [[ $# -lt 2 ]]; then
    error "Missing command argument"
    echo ""
    show_usage
    exit 1
fi

INSTANCE_NAME="$1"
COMMAND="$2"
shift 2

# Validate instance name
if ! validate_instance_name "$INSTANCE_NAME"; then
    exit 1
fi

# Load instance configuration
if ! load_instance_config "$INSTANCE_NAME"; then
    exit 1
fi

# Source appropriate commands library based on deployment type
if [[ "$DEPLOYMENT_TYPE" == "docker" ]]; then
    source "$SCRIPT_DIR/lib/commands-docker.sh"
else
    source "$SCRIPT_DIR/lib/commands.sh"
fi

# Execute command based on deployment type
if [[ "$DEPLOYMENT_TYPE" == "docker" ]]; then
    # Docker deployment commands
    case "$COMMAND" in
        terraform|tf)
            exec_terraform "$@"
            ;;
        connect|admin)
            exec_connect "$@"
            ;;
        backup)
            exec_backup "$@"
            ;;
        restore)
            exec_restore "$@"
            ;;
        ssh)
            exec_ssh "$@"
            ;;
        shell|exec)
            exec_shell "$@"
            ;;
        onboard)
            exec_onboard "$@"
            ;;
        logs)
            exec_logs "$@"
            ;;
        status|info)
            exec_status "$@"
            ;;
        start)
            exec_start "$@"
            ;;
        stop)
            exec_stop "$@"
            ;;
        restart)
            exec_restart "$@"
            ;;
        *)
            error "Unknown command: $COMMAND"
            echo ""
            info "Available commands for Docker host:"
            info "  terraform, tf   - Run Terraform commands"
            info "  connect <bot>   - SSH tunnel to bot admin UI"
            info "  backup [bot]    - Backup bot volumes"
            info "  restore <bot>   - Restore bot from backup"
            info "  ssh             - SSH to Docker host"
            info "  shell <bot>     - Shell into bot container"
            info "  onboard <bot>   - Run onboarding for a bot"
            info "  logs [bot]      - View container logs"
            info "  status          - Show host and container status"
            info "  start [bot]     - Start containers"
            info "  stop [bot]      - Stop containers"
            info "  restart [bot]   - Restart containers"
            exit 1
            ;;
    esac
else
    # Single instance commands
    case "$COMMAND" in
        terraform|tf)
            exec_terraform "$@"
            ;;
        connect|admin)
            exec_connect "$@"
            ;;
        backup)
            exec_backup "$@"
            ;;
        restore)
            exec_restore "$@"
            ;;
        ssh)
            exec_ssh "$@"
            ;;
        status|info)
            exec_status "$@"
            ;;
        *)
            error "Unknown command: $COMMAND"
            echo ""
            show_usage
            exit 1
            ;;
    esac
fi
